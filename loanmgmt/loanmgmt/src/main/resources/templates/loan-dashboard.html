<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <title>Loan Dashboard</title>
  <link rel="stylesheet" href="/css/styles.css"/>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <style>
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 8px; border: 1px solid #ccc; }
    tr:hover { background: #f5f5f5; cursor: pointer; }

    .badge-pending { color: orange; font-weight: bold; }
    .badge-approved { color: green; font-weight: bold; }
    .badge-other { color: red; font-weight: bold; }

    #loanModal {
      position: fixed;
      top: 20%;
      left: 25%;
      width: 50%;
      padding: 20px;
      background: white;
      border: 2px solid #333;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Loan Dashboard</h2>

    <!-- Filters -->
    <div>
      <label>Status Filter:
        <select id="statusFilter">
          <option value="">All</option>
          <option value="PENDING">Pending</option>
          <option value="APPROVED">Approved</option>
          <option value="REJECTED">Rejected</option>
        </select>
      </label>

      <input type="text" id="nameFilter" placeholder="Customer name"/>
      <button id="filterBtn">Filter</button>
    </div>

    <!-- Loan Table -->
    <table id="loanTable">
      <thead>
        <tr>
          <th>App No</th>
          <th>Customer</th>
          <th>Amount</th>
          <th>Tenure</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>

    <!-- Loan Modal -->
    <div id="loanModal">
      <h3>Loan Details</h3>
      <div id="modalContent"></div>
      <button id="closeModal">Close</button>
    </div>
  </div>

<script>
$(function () {

  // ----------------------------
  // LOAD ALL LOANS ON PAGE LOAD
  // ----------------------------
  loadLoans();

  function loadLoans() {
    $.get("/api/loans", function (data) {
      renderTable(data);
    });
  }

  // ----------------------------
  // FILTER BUTTON
  // ----------------------------
  $('#filterBtn').on('click', function () {
    var status = $('#statusFilter').val();
    var name = $('#nameFilter').val();

    $.ajax({
      url: '/api/loans/search',
      method: 'GET',
      data: { status: status, name: name },
      success: function (res) {
        renderTable(res);
      }
    });
  });

  // ----------------------------
  // RENDER TABLE
  // ----------------------------
  function renderTable(loans) {
    var rows = "";
    loans.forEach(l => {
      rows += `
        <tr data-id="${l.id}">
          <td>${l.applicationNumber}</td>
          <td>${l.customerName}</td>
          <td>${l.amount}</td>
          <td>${l.tenureMonths}</td>
          <td><span class="${badgeClass(l.status)}">${l.status}</span></td>
          <td>
             ${l.status === "PENDING" ? getActionButtons(l.id) : ""}
          </td>
        </tr>
      `;
    });
    $("#loanTable tbody").html(rows);
  }

  function badgeClass(status) {
    if (status === "PENDING") return "badge-pending";
    if (status === "APPROVED") return "badge-approved";
    return "badge-other";
  }

  function getActionButtons(id) {
    return `
      <button class="approve-btn" data-id="${id}">Approve</button>
      <button class="reject-btn" data-id="${id}">Reject</button>
    `;
  }

  // ----------------------------
  // SHOW LOAN DETAILS MODAL
  // ----------------------------
  $("#loanTable").on("click", "tr", function (e) {
    // Avoid triggering modal when clicking approve/reject buttons
    if ($(e.target).hasClass("approve-btn") || $(e.target).hasClass("reject-btn")) return;

    var id = $(this).data("id");

    $.get("/api/loans/" + id, function (loan) {
      var html = `
        <p><b>Application No:</b> ${loan.applicationNumber}</p>
        <p><b>Customer:</b> ${loan.customerName}</p>
        <p><b>Amount:</b> ₹ ${loan.amount}</p>
        <p><b>Tenure:</b> ${loan.tenureMonths} months</p>
        <h4>EMI Schedule</h4>
        <ul>
          ${loan.emiSchedule.map(e => `<li>Month ${e.month}: ₹ ${e.emi}</li>`).join("")}
        </ul>
      `;

      $("#modalContent").html(html);
      $("#loanModal").show();
    });
  });

  $("#closeModal").on("click", function () {
    $("#loanModal").hide();
  });

  // ----------------------------
  // APPROVE LOAN
  // ----------------------------
  $(document).on('click', '.approve-btn', function () {
    var id = $(this).data('id');
    $.post(`/api/loans/${id}/approve`, function () {
      alert("Loan approved");
      loadLoans();
    });
  });

  // ----------------------------
  // REJECT LOAN
  // ----------------------------
  $(document).on('click', '.reject-btn', function () {
    var id = $(this).data('id');
    $.post(`/api/loans/${id}/reject`, function () {
      alert("Loan rejected");
      loadLoans();
    });
  });

});
</script>

</body>
</html>